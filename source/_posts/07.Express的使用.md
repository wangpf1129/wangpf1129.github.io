---
title: Express的使用⭐⭐⭐
date: 2020-08-8 15:30:39
index_img: /img/Expressjs.jpg
tags: [Node,Express,art-template,express-session]
categories: Nodejs

---
# 07.Express 的使用
## 1.安装express
```shell
npm install express --save
```
## 2.简单使用express  
```JavaScript
//0.安装

//1. 引入包
const express = require('express');

// 2. 创建服务器应用程序  也就是原来的 http.createServer
const app = express();

// 以get的请求方式来 请求 /   
app.get('/', (req, res) => {
    res.send('hello express!!!');
})

// 相当于 之前的 server.linten
app.listen(3000, () => console.log(`Example app listening on port 3000!`))
```
## 3.基本路由
### get:
```JavaScript
app.get('/',(req,res)=>{
    res.send('Hello World!')
})
```
### post:
```JavaScript
app.post('/',(req,res)=>{
    res.send('Hello World!')
})
```
## 4.获取静态资源
```JavaScript
//  直接可以获取 /public 中的资源
app.use(express.static('public'))
//  直接可以获取 /files 中的资源
app.use(express.static('files'))

//  需要通过 /public/xxx 来获取 public 文件中的资源 推荐使用这种
app.use('/public',express.static('public'))

//  需要通过 /static/xxx 来获取 public 文件中的资源 
app.use('/static',express.static('public'))
```
## 5.在Express 中配置 `art-template` 模板引擎
- [art-template Github仓库](https://github.com/aui/art-template)
- [art-template 官网文档](https://aui.github.io/art-template/)
- 安装：
```shell
npm install --save art-template
npm install --save express-art-template
```
- 配置：
```JavaScript
app.engine('art',require('express-art-template'))

// 这里的html 要和 views 的文件 匹配
app.engine('html',require('express-art-template'))
```
- 使用：
```JavaScript
app.get('/',(req,res)=>{
// express 默认会去项目views 目录中 查找 idenx.html
    res.render('index.html',{
        title: 'heelo world'
    })
})
```
- 如果希望修改默认的 views 视图渲染存储目录， 可以：
```JavaScript
// 注意  第一个参数 views 不能写错
app.set('views',目录路径)
```

## 6.在Express 配置使用 `express-session` 插件

#### 在 Express 框架中，默认不支持 Session 和 Cookie

#### 但是我们可以使用第三方中间件 ： express-session 来解决

> 参考文档：https://www.npmjs.com/package/express-session
安装：

```shell
npm install express-session
```
配置：
```JavaScript
// 该插件会为 req 请求对象添加一个成员：req.session 默认是一个对象
// 这是最简单的配置方式， 暂且不用关心里面的参数含义
app.use(session({
    // 配置加密字符串， 它会在原有的加密基础之上 和 这个字符串'node' 拼起来加密
    // 目的是为了增加安全性， 防止客户端恶意伪造
    secret: 'node',
    resave: false,
    saveUninitialized: true // 默认为true  意思是无论你是否使用了 Session， 都默认的直接给你分配一把钥匙
}))
```

使用：

```JavaScript
// 添加 Session 数据： 
req.session.foo = 'bar'

//  访问 Session 数据： 
req.session.foo
```
##### 提示：默认的 Session 数据是内存存储的，服务器一旦重启就会丢失，真正的生产环境会把Session进行持久化存储。

## 7.在Express 中获取表单GET请求参数
Express 内置了一个 API ， 可以直接通过 `req.query`来获取

## 8.在Express 中获取表单 POST 请求体数据
在Express 中没有内置获取表单 POST 请求体的 API， 所以我们要使用一个第三方包 ： `bdoy-parser`
- 安装
```shell
npm install --save body-parser
```
- 配置
```JavaScript
var express = require('express')

// 0.引包
var bodyParser = require('body-parser')
var app = express()

// 配置 body-parser
// 只要加入下面俩行代码，则在req 请求对象上会多出来一个属性: body
// 也就是说你就可以直接通过 req.body 来获取表单 POST 请求体数据了
// create application/json parser
app.use(bodyParser.json())
// create application/x-www-form-urlencoded parser
app.use(bodyParser.urlencoded({ extended: false }))
```
- 使用：
```JavaScript
app.use(function(req,res){
    res.setHeader('Content-Type','text/plain')
    res.write('you posted: \n')
    // 可以通过 req.body 来获取表单 post 请求体数据
    res.end(JSON.stringify(req.body,null,2))
})

```
## 9.Express 中间件
> 参考文档： http://expressjs.com/en/guide/using-middleware.html#using-middleware

![中间件 类似于自来水厂的流程](https://image.baidu.com/search/detail?ct=503316480&z=0&ipn=d&word=%E8%87%AA%E6%9D%A5%E6%B0%B4%E5%8E%82&step_word=&hs=0&pn=17&spn=0&di=3960&pi=0&rn=1&tn=baiduimagedetail&is=0%2C0&istype=0&ie=utf-8&oe=utf-8&in=&cl=2&lm=-1&st=undefined&cs=3663111018%2C2872047785&os=2674119153%2C3091905494&simid=4252039746%2C522837713&adpicid=0&lpn=0&ln=1748&fr=&fmq=1597577857986_R&fm=&ic=undefined&s=undefined&hd=undefined&latest=undefined&copyright=undefined&se=&sme=&tab=0&width=undefined&height=undefined&face=undefined&ist=&jit=&cg=&bdtype=0&oriquery=&objurl=http%3A%2F%2Fthumb.1010pic.com%2Fpic3%2Fquiz%2Fimages%2F201504%2F222%2F673f4ce9.png&fromurl=ippr_z2C%24qAzdH3FAzdH3Fooo_z%26e3B8a8a3tw3tw5_z%26e3Bv54AzdH3FvzixAzdH3Ffitpt_t1_1d1mc1lwl00majd0kujdjvducl1u1vmm&gsm=13&rpstart=0&rpnum=0&islist=&querylist=&force=undefined)

中间件的本质就是一个请求处理方法，我们把用户从请求到响应的整个过程分发到多个中间件中去处理，这样做的目的是提高代码的灵活性，动态可扩展的
### 9.1 应用程序级别的中间件
万能匹配（不关心任何请求路径和请求方法）
```JavaScript
app.use(function(req,res,next){
    console.log('Time',Date.now())
    next()
})
```
以 '/xxx/' 开头的 条件的 才能匹配
```JavaScript
app.use('/xxx/',function(req,res,next){
    console.log('Time',Date.now())
    next()
})
```
### 9.2 路由级别的中间件
get：
```JavaScript

app.get('/', function (req, res) {
    res.send(' Got a POST request')
})
```
post:
```JavaScript
app.post('/', function (req, res) {
    res.send('Hello world')
})
```

put :
```JavaScript
app.put('/user', function (req, res) {
    res.send(' Got a PUT request at /user')
})
```

delete :
```JavaScript
app.delete('/', function (req, res) {
    res.send(' Got a DELETE request at /user')
 })
```
### 9.3错误处理中间件
```JavaScript
app.use(function(err,req,res,next){
    console.error(err,stack);
    res.status(500).send('Something broke');
});
```
配置使用404中间件：
```JavaScript
app.use(function(req,res){
    res.render('404.html');
});
```
配置全局错误处理中间件:
```JavaScript
app.get('/a', function(req, res, next) {
	fs.readFile('.a/bc', funtion() {
		if (err) {
        	// 当调用next()传参后，则直接进入到全局错误处理中间件方法中
        	// 当发生全局错误的时候，我们可以调用next传递错误对象
        	// 然后被全局错误处理中间件匹配到并进行处理
			next(err);
		}
	})
});
//全局错误处理中间件
app.use(function(err,req,res,next){
    res.status(500).json({
        err_code:500,
        message:err.message
    });
});
```
### 9.4 内置中间件
- express.static(提供静态文件)
    - http://expressjs.com/en/starter/static-files.html#serving-static-files-in-express
### 9.5 第三方中间件
> 参考文档：http://expressjs.com/en/resources/middleware.html
- body-parser
- compression
- cookie-parser
- mogran
- response-time
- server-static
- session


