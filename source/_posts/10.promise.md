---
title: 回调地狱（callback hell） 和 promise
tags: [promise,es6]
index_img: /img/promise回调地狱.jpg
date: 2020-8-12 17:12:00
categories: JavaScript

---

## 1. callback hell  回调地狱
### 1.1 没有顺序的读取 a  b  c 三个文件
```JavaScript
const fs = require('fs')

fs.readFile('./a.txt', 'utf8', function (err, data) {
    if (err) {
        // return console.log('读取错误');

        // 抛出异常
        // 1.阻止程序的执行  2. 把错误消息打印到控制台  
        throw err
    }
    console.log(data);
})
fs.readFile('./b.txt', 'utf8', function (err, data) {
    if (err) {
        // return console.log('读取错误');

        // 抛出异常
        // 1.阻止程序的执行  2. 把错误消息打印到控制台  
        throw err
    }
    console.log(data);
})
fs.readFile('./c.txt', 'utf8', function (err, data) {
    if (err) {
        // return console.log('读取错误');

        // 抛出异常
        // 1.阻止程序的执行  2. 把错误消息打印到控制台  
        throw err
    }
    console.log(data);
})

```
```shell
PS F:\nodejs\Node_test> node .\13.回调地狱.js
hello aaaa
hello bbbb
hello cccc
PS F:\nodejs\Node_test> node .\13.回调地狱.js
hello aaaa
hello cccc
hello bbbb
PS F:\nodejs\Node_test> node .\13.回调地狱.js
hello aaaa
hello cccc
hello bbbb
```
### 1.2 想要有顺序的分别 读取 a b c 三个文件
```JavaScript
const fs = require('fs')

fs.readFile('./a.txt', 'utf8', function (err, data) {
    if (err) {
        // return console.log('读取错误');

        // 抛出异常
        // 1.阻止程序的执行  2. 把错误消息打印到控制台  
        throw err
    }
    console.log(data);
    fs.readFile('./b.txt', 'utf8', function (err, data) {
        if (err) {
            // return console.log('读取错误');

            // 抛出异常
            // 1.阻止程序的执行  2. 把错误消息打印到控制台  
            throw err
        }
        console.log(data);
        fs.readFile('./c.txt', 'utf8', function (err, data) {
            if (err) {
                // return console.log('读取错误');

                // 抛出异常
                // 1.阻止程序的执行  2. 把错误消息打印到控制台  
                throw err
            }
            console.log(data);
        })
    })

})
```
```shell
PS F:\nodejs\Node_test> node .\13.回调地狱.js
hello aaaa
hello bbbb
hello cccc
PS F:\nodejs\Node_test> node .\13.回调地狱.js
hello aaaa
hello bbbb
hello cccc
PS F:\nodejs\Node_test> node .\13.回调地狱.js
hello aaaa
hello bbbb
hello cccc
```

>  想要有顺序的读取异步操作中的文件 就需要回调函数嵌套，但这样的代码 看起来很乱且维护性低 

> 为了解决这样的问题，（回调地狱嵌套） 这时我们就需要用ES6中的API  `promise `
## 2. promise  API
> 参考文档 [promise](https://es6.ruanyifeng.com/#docs/promise)

- 什么情况下会用到 Promise？
- 一般情况下是在有异步请求的时候，使用Promise对这个异步操作进行封装
- new -> 构造函数（1.保存了一些状态信息   2.执行传入的函数）
- 在执行传入的回调函数时，会传俩个函数  resolve 、 reject 。

#### 成功 和 失败 分别怎么调用
- 如果成功， 会调用 resolve()  这个时候，我们后续的 `.then()` 会被回调
- 如果失败，  会调用 reject()  这个时候，我们后续的 `.catch()` 会被调用


```JavaScript
new Promise((resolve, rejects) => {
  setTimeout(() => {
    // 成功时调用 resolve（）
    // resolve('hello world')

    // 失败时调用 reject
    rejects('error message')
  }, 1000)
}).then((data) => {
  console.log(data);
  console.log(data);
  console.log(data);
  console.log(data);
  console.log(data);
}).catch((err) => {
  console.log(err);
  console.log(err);
  console.log(err);
  console.log(err);
})
```

##### Promise 的三种状态
- pending ： 等待状态，比如正在进行网络请求，或者定时器没有到时间
- fulfill ： 满足状态，当我们主动回调了 resolve 时， 就处于该状态，并且会回调 .then()
- reject ：拒绝状态， 当我们主动回调了 reject 时， 就处于该状态，并且会回调 .catch()

#### Promise.all 的使用
> 如果某一个需求需要发俩次请求来能完成

```JavaScript
Promise.all([
  new Promise((resolve, reject) => {
    setTimeout(() => {
      resolve({
        name: 'wpf',
        age: 23
      })
    }, 2000)
  }),
  new Promise((resolve, reject) => {
    setTimeout(() => {
      resolve({
        name: 'zyz',
        age: 24
      })
    }, 1000)
  })
]).then((resolve) => {
  console.log(resolve);
})
```