---
title: 内存管理
index_img: /img/JavaScript高级.png
date: 2021-11-04 18:40:00
tags: [JavaScript高级]
categories: [JavaScript高级]
---

## JavaScript 内存管理

> 很喜欢一句话： 当你理解了内存，很多东西你都会理解

### 认识内存管理

不管什么样的编程语言，在代码的执行过程中都是需要给它分配内存的，不同的是某些编程语言需要我们自己手动的管理内存，某些编程语言会可以自动帮助我们管理内存：

不管以什么样的方式来管理内存，内存的管理都会有如下的生命周期：

1. 分配申请你需要的内存（申请）；
2. 使用分配的内存（存放一些东西，比如对象等）；
3. 不需要使用时，对其进行释放；

不同的编程语言对于第一步和第三步会有不同的实现：

- 手动管理内存：比如 C、C++，包括早期的 OC，都是需要手动来管理内存的申请和释放的（malloc 和 free 函 数）；
- 自动管理内存：比如 Java、JavaScript、Python、Swift、Dart 等，它们有自动帮助我们管理内存；

### JavaScript 的内存管理

JavaScript 会在定义变量时为我们分配内存。

但是内存分配方式是一样的吗？

- JavaScript 对于**基本数据类型**内存的分配会在执行时， 直接在栈空间进行分配；
- JavaScript 对于**复杂数据类型**内存的分配会在堆内存 中开辟一块空间，并且将这块空间的指针返 回值变量`引用`；

按照细分的话可以划分几大类，主要是这两大类

![js内存结构.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2bb3bc0d363e4d06be643e7d3b9106c2~tplv-k3u1fbpfcp-watermark.image?)

### JavaScript 的垃圾回收

因为内存的大小是有限的，所以当内存不再需要的时候，我们需要对其进行释放，以便腾出更多的内存空间。

在手动管理内存的语言中，我们需要通过一些方式自己来释放不再需要的内存，比如 free 函数：

- 但是这种管理的方式其实**非常的低效**，影响我们编写逻辑的代码的效率；
- 并且这种方式**对开发者的要求也很高**，并且一不小心就会产生内存泄露；

所以大部分现代的编程语言都是有自己的垃圾回收机制：

- 垃圾回收的英文是 **Garbage Collection**，简称 **GC**；
- 对于**那些不再使用的对象**，我们都称之为是**垃圾**，它需要被**回收**，以释放更多的内存空间；
- 而我们的语言运行环境，比如 Java 的运行环境 JVM，JavaScript 的运行环境 JavaScript 引擎都会内置 **垃圾回收器**；
- 垃圾回收器我们也会简称为 **GC**，所以在很多地方你看到 **GC** 其实指的是垃圾回收器；

但是这里又出现了另外一个很关键的问题：GC 怎么知道哪些对象是不再使用的呢？

这里就要用到 GC 的算法了

### 常见的 GC 算法

#### 引用计数

当一个对象有一个引用指向它时，默认是 0，那么这个对象的引用就+1，当一个对象的引用为 0 时，这个对象就可以被销毁掉

**但是**这个算法有一个很大的弊端就是会产生**循环引用**，这样就不会被清除了，导致内存泄漏

![引用计数.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/809ce776c2334af3a11df1c29b996cc6~tplv-k3u1fbpfcp-watermark.image?)

### 标记清除

这个算法是设置一个根对象（root object），垃圾回收器会定期从这个根开始，找所有从根开始有引用到的对象，对 于哪些没有引用到的对象，就认为是不可用的对象

这个算法可以很好的解决循环引用的问题

![标记清除.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8eb09b8fcf964932886efea45814b364~tplv-k3u1fbpfcp-watermark.image?)

JS 引擎比较**广泛的采用**的就是标记清除算法，当然类似于 V8 引擎为了进行更好的优化，它在算法的实现细节上也会结合 一些其他的算法。
